<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gubby Clicker - Infinite Scaling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; overflow-x: hidden; }
        @keyframes sky-fall {
            0% { transform: translateY(-20vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(120vh) rotate(var(--sky-rotation)); opacity: 0; }
        }
        @keyframes text-pop {
            0% { opacity: 0; transform: translate(0, 0) scale(0.5); }
            20% { opacity: 1; transform: translate(var(--pop-x), -40px) scale(1.3); }
            100% { opacity: 0; transform: translate(var(--pop-x), -120px) scale(1); }
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes squish { 0% { transform: scale(1, 1); } 30% { transform: scale(1.2, 0.8); } 100% { transform: scale(1, 1); } }
        .animate-sky-fall { animation-name: sky-fall; animation-timing-function: linear; animation-fill-mode: forwards; }
        .animate-text-pop { animation: text-pop 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-shake { animation: shake 0.2s ease-in-out infinite; }
        .animate-squish { animation: squish 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = `<span data-lucide="${name}"></span>`;
                    window.lucide.createIcons({ attrs: { 'stroke-width': 2, width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const App = () => {
            const [clicks, setClicks] = useState(0);
            const [totalClicksSession, setTotalClicksSession] = useState(0); 
            const [gold, setGold] = useState(0);
            const [activeBuff, setActiveBuff] = useState(null);
            const [inventory, setInventory] = useState({ rainbow: 0, mega: 0, omega: 0, godly: 0 });
            const [textParticles, setTextParticles] = useState([]);
            const [notification, setNotification] = useState(null);
            const [skyGubbies, setSkyGubbies] = useState([]);
            const [isSquishing, setIsSquishing] = useState(false);
            const [autoclickers, setAutoclickers] = useState(0);
            const [autoclickerCost, setAutoclickerCost] = useState(150);
            const [prestigeLevel, setPrestigeLevel] = useState(0);
            
            // Battle State
            const [isBattleActive, setIsBattleActive] = useState(false);
            const [battleType, setBattleType] = useState('normal'); 
            const [battleHP, setBattleHP] = useState(0);
            const [maxBattleHP, setMaxBattleHP] = useState(0);
            const [battleTimer, setBattleTimer] = useState(0);
            const [normalBossCount, setNormalBossCount] = useState(0);
            const [megaBossCount, setMegaBossCount] = useState(0);

            const gubbyImgUrl = "https://static.wikia.nocookie.net/parasprunki-fanon/images/1/1e/Gubby.webp";
            const goldCoinUrl = "https://cdn3d.iconscout.com/3d/premium/thumb/star-coin-3d-icon-png-download-11254734.png";
            const megaStarUrl = "https://static.vecteezy.com/system/resources/previews/018/842/628/non_2x/3d-star-icon-isolated-on-background-customer-rating-feedback-concept-3d-rendering-free-png.png";
            const godlyDiamondUrl = "https://cdn3d.iconscout.com/3d/premium/thumb/diamond-3d-icon-png-download-8249311.png";
            const omegaCrownUrl = "https://cdn3d.iconscout.com/3d/premium/thumb/king-crown-3d-icon-png-download-10707831.png";
            const friendImgUrl = "https://static.vecteezy.com/system/resources/thumbnails/012/026/493/small/add-new-friend-user-group-icon-3d-render-png.png";

            const SHOP_ITEMS = [
                { id: 'rainbow', name: 'Rainbow Charge', cost: 250, power: 10, duration: 15, img: 'https://cdn3d.iconscout.com/3d/premium/thumb/rainbow-3d-icon-png-download-4659629.png', color: 'from-pink-100 to-indigo-100', borderColor: 'border-indigo-300', activeColor: 'from-pink-400 to-indigo-400' },
                { id: 'mega', name: 'Mega Charge', cost: 800, power: 25, duration: 12, img: megaStarUrl, color: 'from-yellow-100 to-orange-100', borderColor: 'border-orange-300', activeColor: 'from-yellow-400 to-orange-400' },
                { id: 'omega', name: 'Omega Charge', cost: 2000, power: 120, duration: 10, img: godlyDiamondUrl, color: 'from-purple-100 to-fuchsia-100', borderColor: 'border-fuchsia-300', activeColor: 'from-purple-400 to-fuchsia-400' },
                { id: 'godly', name: 'Godly Core', cost: 5000, power: 500, duration: 8, img: omegaCrownUrl, color: 'from-cyan-100 to-blue-100', borderColor: 'border-blue-300', activeColor: 'from-cyan-400 to-blue-400' }
            ];

            const currentPrestigeCost = Math.floor(10000 * Math.pow(1.5, prestigeLevel));

            useEffect(() => {
                if (autoclickers > 0) {
                    const interval = setInterval(() => {
                        const gain = autoclickers * (prestigeLevel + 1);
                        setClicks(prev => prev + gain);
                        setTotalClicksSession(prev => prev + gain);
                    }, 1000);
                    return () => clearInterval(interval);
                }
            }, [autoclickers, prestigeLevel]);

            useEffect(() => {
                if (totalClicksSession > 0 && !isBattleActive) {
                    const lastProcessedMega = window._lastMegaTriggered || 0;
                    const lastProcessedNormal = window._lastNormalTriggered || 0;

                    if (totalClicksSession >= lastProcessedMega + 500) {
                        triggerBattle('mega');
                        window._lastMegaTriggered = Math.floor(totalClicksSession / 500) * 500;
                    } 
                    else if (totalClicksSession >= lastProcessedNormal + 100) {
                        triggerBattle('normal');
                        window._lastNormalTriggered = Math.floor(totalClicksSession / 100) * 100;
                    }
                }
            }, [totalClicksSession, isBattleActive]);

            const triggerBattle = (type) => {
                const isMega = type === 'mega';
                let hp;
                if (isMega) {
                    hp = 200 + (megaBossCount * 150) + Math.floor(gold / 100);
                } else {
                    hp = 50 + (normalBossCount * 25) + Math.floor(gold / 250);
                }
                
                setBattleType(type);
                setBattleHP(hp);
                setMaxBattleHP(hp);
                setBattleTimer(isMega ? 40 : 20);
                setIsBattleActive(true);
                setNotification({ 
                    title: isMega ? "MEGA BOSS DETECTED!" : "GUBBY BATTLE!", 
                    message: isMega ? `Mega Boss #${megaBossCount + 1} is here! Defeat it in 40s!` : `Gubby Boss #${normalBossCount + 1} appears! 20s left!`, 
                    type: "warning" 
                });
            };

            useEffect(() => {
                const interval = setInterval(() => {
                    if (activeBuff) {
                        setActiveBuff(prev => (!prev || prev.timeLeft <= 1) ? null : { ...prev, timeLeft: prev.timeLeft - 1 });
                    }
                    if (isBattleActive) {
                        setBattleTimer(prev => (prev <= 1) ? (endBattle(false), 0) : prev - 1);
                    }
                }, 1000);

                const skyInterval = setInterval(() => {
                    if (Math.random() > 0.4) {
                        const newGubby = {
                            id: Date.now() + Math.random(),
                            left: Math.random() * 100,
                            size: 15 + Math.random() * 50,
                            duration: 2 + Math.random() * 4,
                            rotation: (Math.random() - 0.5) * 1000
                        };
                        setSkyGubbies(prev => [...prev, newGubby]);
                        setTimeout(() => setSkyGubbies(prev => prev.filter(g => g.id !== newGubby.id)), newGubby.duration * 1000);
                    }
                }, 400);

                return () => { clearInterval(interval); clearInterval(skyInterval); };
            }, [activeBuff, isBattleActive]);

            const endBattle = (won) => {
                setIsBattleActive(false);
                if (won) {
                    if (battleType === 'mega') setMegaBossCount(c => c + 1);
                    else setNormalBossCount(c => c + 1);

                    const reward = Math.floor(maxBattleHP * (battleType === 'mega' ? 15 : 5));
                    setGold(prev => prev + reward);
                    setNotification({ title: "VICTORY!", message: `Boss defeated! Reward: ${reward} Gold. Next one will be stronger.`, type: "success" });
                } else {
                    setNotification({ title: "BATTLE FAILED!", message: `The boss escaped! Try upgrading your power.`, type: "error" });
                }
            };

            const tryAscend = () => {
                if (gold >= currentPrestigeCost) {
                    setNotification({
                        title: "Confirm Ascension?",
                        message: `Reset progress to gain a permanent +1x Power multiplier!`,
                        confirmAction: () => {
                            setPrestigeLevel(prev => prev + 1);
                            setGold(0);
                            setClicks(0);
                            setAutoclickers(0);
                            setAutoclickerCost(150);
                            setNormalBossCount(0);
                            setMegaBossCount(0);
                            setInventory({ rainbow: 0, mega: 0, omega: 0, godly: 0 });
                            setNotification({ title: "ASCENDED!", message: `Prestige Level ${prestigeLevel + 1} reached!`, type: "success" });
                            window._lastNormalTriggered = 0;
                            window._lastMegaTriggered = 0;
                        }
                    });
                } else {
                    setNotification({ title: "Locked", message: `Need ${currentPrestigeCost.toLocaleString()} Gold to Ascend.`, type: "error" });
                }
            };

            const handleMainClick = (e) => {
                const basePower = (prestigeLevel + 1);
                const gain = activeBuff ? activeBuff.multiplier * basePower : basePower;
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left - rect.width / 2;
                const clickY = e.clientY - rect.top - rect.height / 2;

                setIsSquishing(true);
                setTimeout(() => setIsSquishing(false), 200);

                if (isBattleActive) {
                    const damage = activeBuff ? Math.ceil(activeBuff.multiplier * basePower) : basePower;
                    setBattleHP(prev => {
                        const next = prev - damage;
                        if (next <= 0) { setTimeout(() => endBattle(true), 10); return 0; }
                        return next;
                    });
                } else {
                    setClicks(prev => prev + gain);
                    setTotalClicksSession(prev => prev + gain); 
                }

                const textId = Date.now() + Math.random();
                setTextParticles(prev => [...prev, { id: textId, x: clickX, y: clickY, popX: (Math.random() - 0.5) * 40, value: isBattleActive ? "HIT!" : `+${gain}` }]);
                setTimeout(() => setTextParticles(prev => prev.filter(p => p.id !== textId)), 800);
            };

            return (
                <div className="min-h-screen flex flex-col items-center px-4 py-2 select-none relative bg-slate-50 overflow-x-hidden">
                    <div className="fixed inset-0 pointer-events-none z-0">
                        {skyGubbies.map(g => (
                            <img key={g.id} src={gubbyImgUrl} className="absolute animate-sky-fall grayscale brightness-110" style={{ left: `${g.left}%`, width: `${g.size}px`, '--sky-rotation': `${g.rotation}deg`, animationDuration: `${g.duration}s` }} />
                        ))}
                    </div>

                    {notification && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-[2.5rem] max-w-sm w-full shadow-2xl border-4 border-slate-100">
                                <h4 className="font-black text-2xl text-center mb-2 uppercase tracking-tight">{notification.title}</h4>
                                <p className="text-slate-500 text-center mb-6 font-medium leading-snug">{notification.message}</p>
                                <div className="flex flex-col gap-2">
                                    {notification.confirmAction ? (
                                        <>
                                            <button onClick={() => { notification.confirmAction(); setNotification(null); }} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase hover:bg-indigo-700 transition-colors">Ascend</button>
                                            <button onClick={() => setNotification(null)} className="w-full bg-slate-100 text-slate-500 py-4 rounded-2xl font-black uppercase">Not yet</button>
                                        </>
                                    ) : (
                                        <button onClick={() => setNotification(null)} className="w-full bg-black text-white py-4 rounded-2xl font-black uppercase hover:scale-[1.02] transition-transform">Okay</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="z-20 w-full max-w-2xl flex flex-col items-center gap-3 mt-4 mb-2">
                        <div className="flex items-center gap-3">
                            <h1 className="text-3xl font-black text-black tracking-[0.1em] uppercase">Gubby Clicker</h1>
                            {prestigeLevel > 0 && <div className="bg-yellow-400 text-black px-3 py-1 rounded-full font-black text-xs border-2 border-white shadow-sm">P{prestigeLevel}</div>}
                        </div>
                        <div className="w-full bg-white px-8 py-5 rounded-[2.5rem] shadow-xl border border-slate-100 flex items-center justify-between">
                            <div className="flex items-center gap-2 sm:gap-6 flex-1 text-center">
                                <div className="flex-1"><p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Session</p><span className="text-xl font-black">{totalClicksSession.toLocaleString()}</span></div>
                                <div className="flex-1"><p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Clicks</p><span className="text-xl font-black">{clicks.toLocaleString()}</span></div>
                                <div className="flex-1"><p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Gold</p><div className="flex items-center justify-center gap-1"><img src={goldCoinUrl} className="w-4 h-4"/><span className="text-xl font-black">{gold.toLocaleString()}</span></div></div>
                            </div>
                            <div className="flex items-center gap-2 ml-4">
                                <button onClick={tryAscend} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase ${gold >= currentPrestigeCost ? 'bg-indigo-600 text-white animate-pulse' : 'bg-slate-100 text-slate-400'}`}>Ascend</button>
                                <button onClick={() => { if (!isBattleActive && clicks > 0) { setGold(g => g + clicks); setClicks(0); } }} disabled={isBattleActive} className="bg-yellow-400 text-black px-5 py-2 rounded-xl font-black uppercase text-[10px] hover:bg-yellow-300 disabled:opacity-30 shadow-md">Sell</button>
                            </div>
                        </div>
                    </header>

                    <main className="z-10 relative flex flex-col items-center justify-start w-full flex-1 pt-4">
                        <div className="h-16 flex items-center justify-center w-full mb-2">
                            {isBattleActive && (
                                <div className="flex flex-col items-center w-full max-w-xs">
                                    <div className="flex justify-between w-full mb-1">
                                        <span className={`text-xs font-black uppercase ${battleType === 'mega' ? 'text-purple-600' : 'text-red-600'}`}>{battleType === 'mega' ? `Mega Boss #${megaBossCount+1}` : `Normal Boss #${normalBossCount+1}`}</span>
                                        <span className={`text-xs font-black ${battleType === 'mega' ? 'text-purple-600' : 'text-red-600'}`}>{battleTimer}s</span>
                                    </div>
                                    <div className={`w-full h-3 bg-slate-200 rounded-full overflow-hidden border ${battleType === 'mega' ? 'border-purple-300' : 'border-red-300'}`}>
                                        <div className={`h-full transition-all duration-300 ${battleType === 'mega' ? 'bg-gradient-to-r from-purple-600 to-indigo-600' : 'bg-gradient-to-r from-red-600 to-orange-600'}`} style={{ width: `${(battleHP / maxBattleHP) * 100}%` }} />
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="relative">
                            {activeBuff && (
                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-full border shadow-sm z-30 whitespace-nowrap">
                                    <span className="text-[9px] font-black uppercase text-indigo-600">{activeBuff.name}: {activeBuff.timeLeft}s</span>
                                </div>
                            )}
                            <div className="absolute inset-0 pointer-events-none z-40">
                                {textParticles.map(p => (
                                    <span key={p.id} className="absolute font-black text-2xl text-black animate-text-pop drop-shadow-sm" style={{ left: `calc(50% + ${p.x}px)`, top: `calc(50% + ${p.y}px)`, '--pop-x': `${p.popX}px` }}>{p.value}</span>
                                ))}
                            </div>
                            <button onClick={handleMainClick} className={`relative outline-none group ${battleType === 'mega' && isBattleActive ? 'w-64 h-64 sm:w-80 sm:h-80' : 'w-48 h-48 sm:w-64 sm:h-64'} ${isBattleActive ? 'animate-shake' : ''} ${isSquishing ? 'animate-squish' : ''}`}>
                                <img src={gubbyImgUrl} className={`w-full h-full object-contain drop-shadow-2xl transition-all ${isBattleActive && battleType === 'mega' ? 'hue-rotate-[280deg] saturate-200 brightness-110' : ''}`} />
                            </button>
                        </div>
                    </main>

                    <div className="z-20 w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 mb-4">
                        <section className="bg-white p-5 rounded-[2rem] shadow-lg border border-slate-100">
                            <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Shop</h3>
                            <div className="flex flex-col gap-2">
                                <button onClick={() => { if (gold >= autoclickerCost) { setGold(g => g - autoclickerCost); setAutoclickers(a => a + 1); setAutoclickerCost(c => Math.floor(c * 1.5)); }}} className="flex items-center justify-between p-3 rounded-2xl bg-indigo-50/50 hover:bg-indigo-50 border border-transparent hover:border-indigo-200 transition-all">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white rounded-xl p-1 border shadow-sm"><img src={friendImgUrl} className="w-full h-full object-contain"/></div>
                                        <div className="text-left"><p className="font-black text-xs uppercase">Gubby Friend</p><p className="text-[8px] font-bold text-slate-400">+{prestigeLevel + 1} Passive Click/sec</p></div>
                                    </div>
                                    <div className="bg-black text-white px-3 py-1 rounded-lg text-xs font-black">{autoclickerCost} Gold</div>
                                </button>
                                {SHOP_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => { if (gold >= item.cost) { setGold(g => g - item.cost); setInventory(inv => ({ ...inv, [item.id]: inv[item.id] + 1 })); } }} className="flex items-center justify-between p-3 rounded-2xl bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-all">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-white rounded-xl p-1.5 border shadow-sm"><img src={item.img} className="w-full h-full object-contain"/></div>
                                            <div className="text-left"><p className="font-black text-xs uppercase">{item.name}</p><p className="text-[8px] font-bold text-slate-400">{item.power}x Power Â· {item.duration}s</p></div>
                                        </div>
                                        <div className="bg-black text-white px-3 py-1 rounded-lg text-xs font-black">{item.cost} Gold</div>
                                    </button>
                                ))}
                            </div>
                        </section>

                        <section className="bg-white p-5 rounded-[2rem] shadow-lg border border-slate-100">
                            <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Inventory</h3>
                            <div className="grid grid-cols-2 gap-2">
                                {SHOP_ITEMS.map(item => (
                                    <button key={`inv-${item.id}`} onClick={() => { if (inventory[item.id] > 0 && !activeBuff) { setInventory(inv => ({ ...inv, [item.id]: inv[item.id] - 1 })); setActiveBuff({ ...item, multiplier: item.power, timeLeft: item.duration }); } }} disabled={inventory[item.id] === 0 || activeBuff !== null} className={`relative flex flex-col items-center justify-center p-3 rounded-2xl border transition-all ${inventory[item.id] > 0 ? `bg-gradient-to-br ${item.color} ${item.borderColor}` : 'bg-slate-50 border-slate-100 opacity-50 grayscale'}`}>
                                        <img src={item.img} className="w-8 h-8 mb-1 object-contain"/>
                                        <span className="text-[8px] font-black uppercase">{item.name.split(' ')[0]}</span>
                                        <span className="absolute -top-1 -right-1 w-5 h-5 bg-black text-white rounded-full flex items-center justify-center text-[8px] font-black border-2 border-white">{inventory[item.id]}</span>
                                    </button>
                                ))}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
